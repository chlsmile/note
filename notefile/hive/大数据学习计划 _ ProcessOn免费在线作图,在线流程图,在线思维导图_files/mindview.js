$(function(){function a(b){$.get("/diagraming/getdef?tempId="+tempId,{id:chartId},function(c){b(JSON.parse(c.def))})}a(function(b){mind=new mindDesigner("#mind_con",{chartId:chartId,readonly:true},JSON.stringify(b),themeDef);mind.util.clearSelect();initChartOperate();initCommentPost();warnUserClone()})});function initChartOperate(){d();$(window).on("resize.view",function(){d()});function d(){var e=$(window).height();$("#mind_con").height(e);$("#mind_con").width($(window).width()-46);$(".reply_list").height(e-184)}$(".item[comment]").on("click",function(){var e=$(".pop-con.info"),f=$(this);if(e.css("opacity")==1){e.css({opacity:0,right:-446});f.removeClass("active")}else{e.css({opacity:1,right:46});f.addClass("active");if($(".reply_list").text()==""){loadComments()}}});$(".item[share]").on("click",function(){var e=$(".pop-con.share"),f=$(this);if(e.css("opacity")==1){e.css({opacity:0,right:-446});f.removeClass("active")}else{e.css({opacity:1,right:46});f.addClass("active")}});$(".con-close").on("click",function(){var e=$(".pop-con");e.css({opacity:0,right:-446});$(".item[comment]").removeClass("active")});$(".viewtitle .down").on("click",function(){var e=$(this);if($(".chart-des").is(":visible")){$(".chart-des").hide();e.html("&#xe617;");$(".chart-pubtime").hide()}else{e.html("&#xe68d;");$(".chart-des").show();$(".chart-pubtime").show()}});$("#movecenter").on("click",function(){mind.operation.moveToCenter.call(mind)});$("#userlike").on("click",function(){doLikeChart(this)});$("#userfav").on("click",function(){doFavourite()});$("#userReport").on("click",function(){$("#report-page").dialog();$("#btn_submit_report").enable().off().on("click",function(){var e=$("#report_content").val();if(!e){Util.globalTopTip("举报信息不能为空","top_error",3000,$("#report-page"),true);return}else{if(e.length>200){Util.globalTopTip("举报信息不能超过200个字符","top_error",3000,$("#report-page"),true);return}}$(this).disable();Util.ajax({url:"/view/report",data:{chartId:chartId,content:e},success:function(f){Util.globalTopTip("您的举报信息已提交",null,3000,$("#report-page"),true);setTimeout(function(){$("#report-page").dialog("close")},3000)}})})});$(".viewtitle,.pop-con,.alert").on("mousedown",function(f){f.stopPropagation()});var b=1;$("#mind_con").bind("dragstart",function(){return false});$(document).on("dblclick",".topic-box",function(g){var f=$(this);f.children(".expand_box").trigger("click.expand")});var a=$("#mind_con")[0];var c=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullScreen;if(c){$("#mind_con").unbind("webkitfullscreenchange").bind("webkitfullscreenchange",function(f){toogleFullDocument()});$(document).unbind("mozfullscreenchange").unbind("fullscreenchange").bind("mozfullscreenchange",function(f){toogleFullDocument()}).bind("fullscreenchange",function(f){toogleFullDocument()});$("#op_fullscreen").bind("click",function(f){c.call(a)});$(window).bind("keydown",function(f){if(f.keyCode==122){c.call(a);f.preventDefault()}})}else{$("#op_fullscreen").bind("click",function(f){toogleFullDocument(false)});$(window).bind("keydown",function(f){if(f.keyCode==122){toogleFullDocument()}})}$("#op_zoomin").bind("click",function(){mind.operation.zoomIn(mind.designer)});$("#op_zoomout").bind("click",function(){mind.operation.zoomOut(mind.designer)})}var isFullScreen=false;function toogleFullDocument(b){isFullScreen=!isFullScreen;if(isFullScreen){fullDocument()}else{exitFullDocument()}var a=$("#op_fullscreen").parent();if(isFullScreen){if(typeof b!="undefined"){a.show()}else{a.hide()}}else{a.show()}}function fullDocument(){$("#mind_con").addClass("full_document");$("#mind_con").css({height:window.screen.height});$("body").addClass("overhidden");$(".ico_fullscreen").addClass("exit");mind.operation.moveToCenter.call(mind)}function exitFullDocument(){$("#mind_con").removeClass("full_document");$("#mind_con").css({height:$(window).height()});$("body").removeClass("overhidden");$(".ico_fullscreen").removeClass("exit");mind.operation.moveToCenter.call(mind)}var chartCloning=false;function newCreateConfirm(a){if(chartCloning){return}chartCloning=true;Util.loadingball({});Util.ajax({url:"/diagraming/clone_check",data:{chartId:a,teamId:cteamId},success:function(b){Util.loadingball({close:true});if(b.result=="clone"){location="/diagraming/new?template="+a+"&category=mind&team="+cteamId;return}chartCloning=false;if(b.result=="cloneBuy"){Util.payWindow("open",{chartId:a,price:b.price},function(){});return}if(b.result=="overd"){Util.globalTopTip("您的文件数量不足，无法克隆,您可以去 <a href='/upgrade' target='_blank'>升级账号</a>","top_error",5000);return}Util.globalTopTip("操作有误，请稍后再试","top_error",5000)}})}function initCommentPost(){$("#comment").bind("keydown",function(a){if(a.ctrlKey&&a.keyCode==13){submitComment()}}).streamInput({face:$("#showFaces")});$("#btn-comment").off().on("click",function(a){if($(this).attr("disabled")){return}submitComment();a.stopPropagation()})}function submitComment(d,c,e){var a=$("#comment").clone();if(d!=null){a=d}var b=a.html().replace(/<img(\s|\S)+?src=\"/g,":lt: class=ico-face src=").replace(/\">/g,":gt:").trim();b=Util.filterXss(b);if(b!=""){$("#btn-comment").attr("disabled","disabled");Util.ajax({url:"/view/submitcomment",data:{chartId:chartId,content:b,ownerId:ownerId,refId:c},success:function(f){$("#comment_count").text(parseInt($("#comment_count").text())+1);$(".reply_list").append(f);$("#btn-comment").removeAttr("disabled");$("#comment").empty();$(".reply_list").scrollTop(9999);checkCommentCount();a.remove();if(e!=null){e()}}})}}function commentRef(b,a){var d=$(b).parent().next(".reply_box_ref");if(d.length==0){d=$("<div class='reply_box_ref'><div class='white_line'></div>回复此评论：<div class='txt text-input' contentEditable='true' spellcheck='false' id='reply-input' accesskey='q'></div><span  class='button' >发表评论</span><span id='showfaces-reply' class='icons'>&#xe70e;</span></div>");$(b).parent().after(d);function c(){var e=d.children(".txt");submitComment(e,a,function(){d.remove()})}d.children(".button").on("click",function(){c()})}if(d.is(":visible")){d.slideUp(200)}else{d.slideDown(200);d.find(".txt").focus()}$("#showfaces-reply").on("click",function(){showFaces($("#showfaces-reply"),$("#reply-input"))})}function openDeldia(b,c){var a=$("#stream_delete_confirm");if(a.length==0){a=$("<div id='stream_delete_confirm' class='alert'>确认删除此条评论吗？<div class='stream_delete_btns'><span class='button ok'>确定</span>&nbsp;&nbsp;&nbsp;<span class='cancel'>取消</span><div></div>").appendTo("body")}a.popMenu({target:$(c),position:"center",zindex:4});a.find(".cancel").off().on("mousedown",function(){a.popMenu("close")});a.find(".ok").off().on("mousedown",function(d){Util.ajax({url:"/view/delComments",data:{refId:b,chartId:chartId},success:function(f){$(c).parents("li").remove();var g=$("#comment_count"),e=Number(g.text());g.text(e-1);checkCommentCount()}});a.popMenu("close")})}function showFaces(c,b){var a=$("#faces_dialog"),d=b||$("#comment");if(a.length>0){a.popMenu({target:c,position:"right",zindex:4});return}var a=$('<div id="faces_dialog" class="faces-lib"><ul><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><div class="clear"></div></ul></div>');a.appendTo("body");a.popMenu({target:c,position:"right"});a.find("li").on("mousedown",function(h){var g=$(this).index();var f="<img class='ico-face' src='/assets/images/faces/faces/"+(g+1)+".gif' />";d.append(f);a.popMenu("close");h.stopPropagation()})}var currentSkip=-15;function loadComments(){currentSkip+=15;$("#more_btn").attr("disabled","disabled").val("加载中...");Util.ajax({url:"/view/loadcomments",data:{chartId:chartId,skip:currentSkip,ownerId:ownerId},success:function(a){$(".reply_list").append(a);if($(".reply_list").find("li").length==15){$(".load_more").show()}if($.trim(a)==""){$(".load_more").hide()}checkCommentCount()}})}function checkCommentCount(){var a=$(".reply_list");if($.trim(a.text())==""){a.html("<span id='none-tip' style='display:inline-block;margin-top:6px;'>当前文件还没有评论</span>")}else{$("#none-tip").remove()}}function doFavourite(){var a=$("#userfav");a.disable();if(a.hasClass("active")){a.numberTip({val:"-1"})}else{a.numberTip()}Util.ajax({url:"/view/favouriteChart",data:{chartId:chartId},success:function(d){a.enable();var e=a.find(".item-count"),c=Number(e.text());if(d.result=="save"){e.text(c+1);a.attr("class","item active")}else{var b=c-1;e.text(b<0?0:b);a.attr("class","item")}}})}function doLikeChart(){var a=$("#userlike");a.disable();if(a.hasClass("active")){a.numberTip({val:"-1"})}else{a.numberTip()}Util.ajax({url:"/view/dolike",data:{chartId:chartId},success:function(b){a.enable();if(b.result){a.attr("title","取消赞");a.attr("class","item active")}else{a.attr("title","赞一下");a.attr("class","item")}a.find(".item-count").text(b.count)}})}function showWeixin(g){var f=$(g).offset().left;var e=$(g).offset().top;var c=window.location.href;var a=$("#pageurl_div");if(a.length>0){a.show();return}var d=$('<div id="pageurl_div" class="weixin-con"><img id="pageurl" src=""/><div>微信扫一扫 分享</div></div>');d.appendTo("body");var b="https://api.qrserver.com/v1/create-qr-code/?data="+c+"&show_wechat_share_tip=true&size=180x180";$("#pageurl").attr("src",b);$("#pageurl_div").css({left:f,top:e-$("#pageurl_div").outerHeight()-6}).show();$(document).on("mousedown",function(){$("#pageurl_div").hide()})}function warnUserClone(){var b=Util.getUrlParams("fromnew");if(!b==0){var c=$(".item-clone-opt"),a=c.length;if(a>0){$(".new-clone-tip").fadeIn();window.setTimeout(function(){$(".new-clone-tip").fadeOut()},5000)}}else{$(".new-clone-tip").hide()}};