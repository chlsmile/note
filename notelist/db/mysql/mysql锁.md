## mysql锁

### 一.mysql锁类型
> mysql中的锁类型有两种分别是读锁(也叫作共享锁)和写锁(也叫作排他锁).

#### 1.1.读锁
- 读锁是共享的,或者说是相互不阻塞的.多个客户在同一时刻可以同时读取同一个资源,而互不干扰.
#### 1.2.写锁
- 写锁是排他的,也就是说一个写锁会阻塞其他的写锁和读锁,这是出于安全策略的考虑,只有这样,才能确保在给定的时间里,只有一个用户能执行写入,并防止其他用户读取正在写入的同一资源.

### 二.mysql锁粒度
> mysql中的锁粒度分为表锁和行级锁.

#### 2.1.表锁
- 表锁是mysql中最基本的锁策略,并且是开销最小的策略.表锁会锁定整张表.一个用户在对表进行写操作(插入,删除,更新等)前,需要先获得写锁,这会阻塞其他用户对该表的所有读写操作.
- 只有没有写锁时,其他读取的用户才能获得读锁,读锁之间是不互相阻塞的.

#### 2.2.行级锁
- 行级锁可以最大程度地支持并发处理(同时也带来了最大的锁开销),行级锁只在存储引擎层实现,而mysql服务器层没有实现.服务器层完全不了解存储引擎中的锁实现.

### 三.mysql乐观锁与悲观锁
#### 3.1.悲观锁
- 悲观锁,正如其名,它指的是对数据被外界(包括本系统当前的其他事务,以及来自外部系统的事务处理)修改持保守态度,因此,在整个数据处理过程中,将数据处于锁定状态.悲观锁的实现,往往依靠数据库提供的锁机制(也只有数据库层提供的锁机制才能真正保证数据访问的排他性,否则,即使在本系统中实现了加锁机制,也无法保证外部系统不会修改数据).

#### 3.2乐观锁
- 乐观锁(Optimistic Locking)相对悲观锁而言,乐观锁假设认为数据一般情况下不会造成冲突,所以在数据进行提交更新的时候,才会正式对数据的冲突与否进行检测,如果发现冲突了,则让返回用户错误的信息,让用户决定如何去做.那么我们如何实现乐观锁呢,一般来说有以下2种方式:
- 使用数据版本(Version)记录机制实现,这是乐观锁最常用的一种实现方式.何谓数据版本?即为数据增加一个版本标识,一般是通过为数据库表增加一个数字类型的“version”字段来实现.当读取数据时,将version字段的值一同读出,数据每更新一次,对此version值加一.当我们提交更新的时候,判断数据库表对应记录的当前版本信息与第一次取出来的version值进行比对,如果数据库表当前版本号与第一次取出来的version值相等,则予以更新,否则认为是过期数据.
- 乐观锁定的第二种实现方式和第一种差不多,同样是在需要乐观锁控制的table中增加一个字段,名称无所谓,字段类型使用时间戳(timestamp),和上面的version类似,也是在更新提交的时候检查当前数据库中数据的时间戳和自己更新前取到的时间戳进行对比,如果一致则OK,否则就是版本冲突。

